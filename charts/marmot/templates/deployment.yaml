apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "marmot.fullname" . }}
  labels:
    {{- include "marmot.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "marmot.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "marmot.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "marmot.serviceAccountName" . }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
            {{- if .Values.config.metrics.enabled }}
            - name: metrics
              containerPort: {{ .Values.config.metrics.port }}
              protocol: TCP
            {{- end }}
          env:
            # Server configuration
            - name: MARMOT_SERVER_PORT
              value: {{ .Values.config.server.port | quote }}
            - name: MARMOT_SERVER_HOST
              value: {{ .Values.config.server.host | quote }}
            {{- if .Values.config.server.rootUrl }}
            - name: MARMOT_SERVER_ROOT_URL
              value: {{ .Values.config.server.rootUrl | quote }}
            {{- end }}
            {{- if or .Values.config.server.encryptionKey .Values.config.server.encryptionKeySecretRef .Values.config.server.autoGenerateEncryptionKey }}
            - name: MARMOT_SERVER_ENCRYPTION_KEY
              {{- if .Values.config.server.encryptionKeySecretRef }}
              {{- if and .Values.config.server.encryptionKey .Values.config.server.encryptionKeySecretRef }}
              {{- fail "Cannot specify both config.server.encryptionKey and config.server.encryptionKeySecretRef" }}
              {{- end }}
              {{- if .Values.config.server.autoGenerateEncryptionKey }}
              {{- fail "Cannot specify both config.server.autoGenerateEncryptionKey and config.server.encryptionKeySecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.server.encryptionKeySecretRef.name }}
                  key: {{ .Values.config.server.encryptionKeySecretRef.key }}
              {{- else if .Values.config.server.encryptionKey }}
              {{- if .Values.config.server.autoGenerateEncryptionKey }}
              {{- fail "Cannot specify both config.server.autoGenerateEncryptionKey and config.server.encryptionKey" }}
              {{- end }}
              value: {{ .Values.config.server.encryptionKey | quote }}
              {{- else if .Values.config.server.autoGenerateEncryptionKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ include "marmot.fullname" . }}-encryption-key
                  key: encryption-key
              {{- end }}
            {{- end }}
            - name: MARMOT_SERVER_ALLOW_UNENCRYPTED
              value: {{ .Values.config.server.allowUnencrypted | quote }}

            # Database configuration - use subchart values if enabled
            - name: MARMOT_DATABASE_HOST
              {{- if .Values.cnpg.enabled }}
              {{- if .Values.cnpg.pooler.enabled }}
              value: {{ include "marmot.fullname" . }}-pooler-rw
              {{- else }}
              value: {{ include "marmot.fullname" . }}-cnpg-rw
              {{- end }}
              {{- else if .Values.postgresql.enabled }}
              {{- if eq .Values.postgresql.architecture "replication" }}
              value: {{ include "marmot.fullname" . }}-postgresql-primary
              {{- else }}
              value: {{ include "marmot.fullname" . }}-postgresql
              {{- end }}
              {{- else }}
              value: {{ .Values.config.database.host | quote }}
              {{- end }}
            - name: MARMOT_DATABASE_PORT
              {{- if or .Values.cnpg.enabled .Values.postgresql.enabled }}
              value: "5432"
              {{- else }}
              value: {{ .Values.config.database.port | quote }}
              {{- end }}
            - name: MARMOT_DATABASE_USER
              {{- if .Values.cnpg.enabled }}
              value: {{ .Values.cnpg.username | default "marmot" | quote }}
              {{- else if .Values.postgresql.enabled }}
              value: {{ .Values.postgresql.auth.username | quote }}
              {{- else }}
              value: {{ .Values.config.database.user | quote }}
              {{- end }}
            - name: MARMOT_DATABASE_NAME
              {{- if .Values.cnpg.enabled }}
              value: {{ .Values.cnpg.database | default "marmot" | quote }}
              {{- else if .Values.postgresql.enabled }}
              value: {{ .Values.postgresql.auth.database | quote }}
              {{- else }}
              value: {{ .Values.config.database.name | quote }}
              {{- end }}
            - name: MARMOT_DATABASE_SSLMODE
              value: {{ .Values.config.database.sslmode | quote }}
            - name: MARMOT_DATABASE_MAX_CONNS
              value: {{ .Values.config.database.maxConns | quote }}
            - name: MARMOT_DATABASE_IDLE_CONNS
              value: {{ .Values.config.database.idleConns | quote }}
            - name: MARMOT_DATABASE_CONN_LIFETIME
              value: {{ .Values.config.database.connLifetime | quote }}
            {{- if .Values.config.search }}
            {{- if .Values.config.search.timeout }}
            - name: MARMOT_SEARCH_TIMEOUT
              value: {{ .Values.config.search.timeout | quote }}
            {{- end }}
            {{- end }}
            - name: MARMOT_DATABASE_PASSWORD
              {{- if .Values.cnpg.enabled }}
              valueFrom:
                secretKeyRef:
                  name: {{ include "marmot.fullname" . }}-cnpg-auth
                  key: password
              {{- else if .Values.postgresql.enabled }}
              valueFrom:
                secretKeyRef:
                  name: {{ include "marmot.fullname" . }}-postgresql
                  key: password
              {{- else if .Values.config.database.passwordSecretRef }}
              {{- if and .Values.config.database.password .Values.config.database.passwordSecretRef }}
              {{- fail "Cannot specify both config.database.password and config.database.passwordSecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.database.passwordSecretRef.name }}
                  key: {{ .Values.config.database.passwordSecretRef.key }}
              {{- else }}
              value: {{ .Values.config.database.password | quote }}
              {{- end }}
            
            # Logging configuration
            - name: MARMOT_LOGGING_LEVEL
              value: {{ .Values.config.logging.level | quote }}
            - name: MARMOT_LOGGING_FORMAT
              value: {{ .Values.config.logging.format | quote }}
            
            # Metrics configuration
            - name: MARMOT_METRICS_ENABLED
              value: {{ .Values.config.metrics.enabled | quote }}
            {{- if .Values.config.metrics.enabled }}
            - name: MARMOT_METRICS_PORT
              value: {{ .Values.config.metrics.port | quote }}
            {{- if .Values.config.metrics.ownerMetadataFields }}
            - name: MARMOT_METRICS_OWNER_METADATA_FIELDS
              value: {{ .Values.config.metrics.ownerMetadataFields | join "," | quote }}
            {{- end }}
            {{- if .Values.config.metrics.schemas.excludedAssetTypes }}
            - name: MARMOT_METRICS_SCHEMAS_EXCLUDED_ASSET_TYPES
              value: {{ .Values.config.metrics.schemas.excludedAssetTypes | join "," | quote }}
            {{- end }}
            {{- if .Values.config.metrics.schemas.excludedProviders }}
            - name: MARMOT_METRICS_SCHEMAS_EXCLUDED_PROVIDERS
              value: {{ .Values.config.metrics.schemas.excludedProviders | join "," | quote }}
            {{- end }}
            {{- end }}

            # OpenLineage configuration
            - name: MARMOT_OPENLINEAGE_AUTH_ENABLED
              value: {{ .Values.config.openlineage.auth.enabled | quote }}

            # Auth configuration
            - name: MARMOT_AUTH_ANONYMOUS_ENABLED
              value: {{ .Values.config.auth.anonymous.enabled | quote }}
            - name: MARMOT_AUTH_ANONYMOUS_ROLE
              value: {{ .Values.config.auth.anonymous.role | quote }}
            
            # OAuth provider configuration
            {{- if and .Values.config.auth.providers .Values.config.auth.providers.okta .Values.config.auth.providers.okta.enabled }}
            - name: MARMOT_AUTH_PROVIDERS_OKTA_ENABLED
              value: "true"
            - name: MARMOT_AUTH_PROVIDERS_OKTA_TYPE
              value: {{ .Values.config.auth.providers.okta.type | quote }}
            - name: MARMOT_AUTH_PROVIDERS_OKTA_NAME
              value: {{ .Values.config.auth.providers.okta.name | quote }}
            - name: MARMOT_AUTH_PROVIDERS_OKTA_CLIENT_ID
              value: {{ .Values.config.auth.providers.okta.clientId | quote }}
            - name: MARMOT_AUTH_PROVIDERS_OKTA_URL
              value: {{ .Values.config.auth.providers.okta.url | quote }}
            - name: MARMOT_AUTH_PROVIDERS_OKTA_REDIRECT_URL
              value: {{ .Values.config.auth.providers.okta.redirectUrl | quote }}
            - name: MARMOT_AUTH_PROVIDERS_OKTA_ALLOW_SIGNUP
              value: {{ .Values.config.auth.providers.okta.allowSignup | quote }}
            
            # OAuth client secret - prefer secretRef, fallback to direct value
            - name: MARMOT_AUTH_PROVIDERS_OKTA_CLIENT_SECRET
              {{- if .Values.config.auth.providers.okta.clientSecretRef }}
              {{- if and .Values.config.auth.providers.okta.clientSecret .Values.config.auth.providers.okta.clientSecretRef }}
              {{- fail "Cannot specify both config.auth.providers.okta.clientSecret and config.auth.providers.okta.clientSecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.auth.providers.okta.clientSecretRef.name }}
                  key: {{ .Values.config.auth.providers.okta.clientSecretRef.key }}
              {{- else }}
              value: {{ .Values.config.auth.providers.okta.clientSecret | quote }}
              {{- end }}
            {{- end }}

            {{- if and .Values.config.auth.providers .Values.config.auth.providers.google .Values.config.auth.providers.google.enabled }}
            - name: MARMOT_AUTH_GOOGLE_ENABLED
              value: "true"
            - name: MARMOT_AUTH_GOOGLE_CLIENT_ID
              value: {{ .Values.config.auth.providers.google.clientId | quote }}
            - name: MARMOT_AUTH_GOOGLE_REDIRECT_URL
              value: {{ .Values.config.auth.providers.google.redirectUrl | quote }}
            - name: MARMOT_AUTH_GOOGLE_ALLOW_SIGNUP
              value: {{ .Values.config.auth.providers.google.allowSignup | quote }}
            - name: MARMOT_AUTH_GOOGLE_CLIENT_SECRET
              {{- if .Values.config.auth.providers.google.clientSecretRef }}
              {{- if and .Values.config.auth.providers.google.clientSecret .Values.config.auth.providers.google.clientSecretRef }}
              {{- fail "Cannot specify both config.auth.providers.google.clientSecret and config.auth.providers.google.clientSecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.auth.providers.google.clientSecretRef.name }}
                  key: {{ .Values.config.auth.providers.google.clientSecretRef.key }}
              {{- else }}
              value: {{ .Values.config.auth.providers.google.clientSecret | quote }}
              {{- end }}
            {{- end }}

            {{- if and .Values.config.auth.providers .Values.config.auth.providers.github .Values.config.auth.providers.github.enabled }}
            - name: MARMOT_AUTH_GITHUB_ENABLED
              value: "true"
            - name: MARMOT_AUTH_GITHUB_CLIENT_ID
              value: {{ .Values.config.auth.providers.github.clientId | quote }}
            - name: MARMOT_AUTH_GITHUB_REDIRECT_URL
              value: {{ .Values.config.auth.providers.github.redirectUrl | quote }}
            - name: MARMOT_AUTH_GITHUB_ALLOW_SIGNUP
              value: {{ .Values.config.auth.providers.github.allowSignup | quote }}
            - name: MARMOT_AUTH_GITHUB_CLIENT_SECRET
              {{- if .Values.config.auth.providers.github.clientSecretRef }}
              {{- if and .Values.config.auth.providers.github.clientSecret .Values.config.auth.providers.github.clientSecretRef }}
              {{- fail "Cannot specify both config.auth.providers.github.clientSecret and config.auth.providers.github.clientSecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.auth.providers.github.clientSecretRef.name }}
                  key: {{ .Values.config.auth.providers.github.clientSecretRef.key }}
              {{- else }}
              value: {{ .Values.config.auth.providers.github.clientSecret | quote }}
              {{- end }}
            {{- end }}

            {{- if and .Values.config.auth.providers .Values.config.auth.providers.gitlab .Values.config.auth.providers.gitlab.enabled }}
            - name: MARMOT_AUTH_GITLAB_ENABLED
              value: "true"
            - name: MARMOT_AUTH_GITLAB_CLIENT_ID
              value: {{ .Values.config.auth.providers.gitlab.clientId | quote }}
            - name: MARMOT_AUTH_GITLAB_URL
              value: {{ .Values.config.auth.providers.gitlab.url | quote }}
            - name: MARMOT_AUTH_GITLAB_REDIRECT_URL
              value: {{ .Values.config.auth.providers.gitlab.redirectUrl | quote }}
            - name: MARMOT_AUTH_GITLAB_ALLOW_SIGNUP
              value: {{ .Values.config.auth.providers.gitlab.allowSignup | quote }}
            - name: MARMOT_AUTH_GITLAB_CLIENT_SECRET
              {{- if .Values.config.auth.providers.gitlab.clientSecretRef }}
              {{- if and .Values.config.auth.providers.gitlab.clientSecret .Values.config.auth.providers.gitlab.clientSecretRef }}
              {{- fail "Cannot specify both config.auth.providers.gitlab.clientSecret and config.auth.providers.gitlab.clientSecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.auth.providers.gitlab.clientSecretRef.name }}
                  key: {{ .Values.config.auth.providers.gitlab.clientSecretRef.key }}
              {{- else }}
              value: {{ .Values.config.auth.providers.gitlab.clientSecret | quote }}
              {{- end }}
            {{- end }}

            {{- if and .Values.config.auth.providers .Values.config.auth.providers.slack .Values.config.auth.providers.slack.enabled }}
            - name: MARMOT_AUTH_SLACK_ENABLED
              value: "true"
            - name: MARMOT_AUTH_SLACK_CLIENT_ID
              value: {{ .Values.config.auth.providers.slack.clientId | quote }}
            - name: MARMOT_AUTH_SLACK_REDIRECT_URL
              value: {{ .Values.config.auth.providers.slack.redirectUrl | quote }}
            - name: MARMOT_AUTH_SLACK_ALLOW_SIGNUP
              value: {{ .Values.config.auth.providers.slack.allowSignup | quote }}
            - name: MARMOT_AUTH_SLACK_CLIENT_SECRET
              {{- if .Values.config.auth.providers.slack.clientSecretRef }}
              {{- if and .Values.config.auth.providers.slack.clientSecret .Values.config.auth.providers.slack.clientSecretRef }}
              {{- fail "Cannot specify both config.auth.providers.slack.clientSecret and config.auth.providers.slack.clientSecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.auth.providers.slack.clientSecretRef.name }}
                  key: {{ .Values.config.auth.providers.slack.clientSecretRef.key }}
              {{- else }}
              value: {{ .Values.config.auth.providers.slack.clientSecret | quote }}
              {{- end }}
            {{- end }}

            {{- if and .Values.config.auth.providers .Values.config.auth.providers.auth0 .Values.config.auth.providers.auth0.enabled }}
            - name: MARMOT_AUTH_AUTH0_ENABLED
              value: "true"
            - name: MARMOT_AUTH_AUTH0_CLIENT_ID
              value: {{ .Values.config.auth.providers.auth0.clientId | quote }}
            - name: MARMOT_AUTH_AUTH0_URL
              value: {{ .Values.config.auth.providers.auth0.url | quote }}
            - name: MARMOT_AUTH_AUTH0_REDIRECT_URL
              value: {{ .Values.config.auth.providers.auth0.redirectUrl | quote }}
            - name: MARMOT_AUTH_AUTH0_ALLOW_SIGNUP
              value: {{ .Values.config.auth.providers.auth0.allowSignup | quote }}
            - name: MARMOT_AUTH_AUTH0_CLIENT_SECRET
              {{- if .Values.config.auth.providers.auth0.clientSecretRef }}
              {{- if and .Values.config.auth.providers.auth0.clientSecret .Values.config.auth.providers.auth0.clientSecretRef }}
              {{- fail "Cannot specify both config.auth.providers.auth0.clientSecret and config.auth.providers.auth0.clientSecretRef" }}
              {{- end }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.config.auth.providers.auth0.clientSecretRef.name }}
                  key: {{ .Values.config.auth.providers.auth0.clientSecretRef.key }}
              {{- else }}
              value: {{ .Values.config.auth.providers.auth0.clientSecret | quote }}
              {{- end }}
            {{- end }}

            # Rate limit configuration
            - name: MARMOT_RATE_LIMIT_ENABLED
              value: {{ .Values.config.rateLimit.enabled | quote }}

            # UI configuration
            - name: MARMOT_UI_BANNER_ENABLED
              value: {{ .Values.config.ui.banner.enabled | quote }}
            {{- if .Values.config.ui.banner.enabled }}
            - name: MARMOT_UI_BANNER_DISMISSIBLE
              value: {{ .Values.config.ui.banner.dismissible | quote }}
            - name: MARMOT_UI_BANNER_VARIANT
              value: {{ .Values.config.ui.banner.variant | quote }}
            - name: MARMOT_UI_BANNER_MESSAGE
              value: {{ .Values.config.ui.banner.message | quote }}
            - name: MARMOT_UI_BANNER_ID
              value: {{ .Values.config.ui.banner.id | quote }}
            {{- end }}

            # Pipelines configuration
            - name: MARMOT_PIPELINES_MAX_WORKERS
              value: {{ .Values.config.pipelines.maxWorkers | quote }}
            - name: MARMOT_PIPELINES_SCHEDULER_INTERVAL
              value: {{ .Values.config.pipelines.schedulerInterval | quote }}
            - name: MARMOT_PIPELINES_LEASE_EXPIRY
              value: {{ .Values.config.pipelines.leaseExpiry | quote }}
            - name: MARMOT_PIPELINES_CLAIM_EXPIRY
              value: {{ .Values.config.pipelines.claimExpiry | quote }}

            # Additional environment variables
            {{- range $key, $value := .Values.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
          {{- with .Values.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.volumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.volumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
